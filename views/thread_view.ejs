<%- include('layout', { title: thread.title || 'Thread', body: `
<div class="max-w-3xl mx-auto">

  <div class="card p-6 rounded mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-2xl font-bold">${thread.title}</h1>
        <div class="muted text-sm mt-1">by ${thread.author?.username || 'Anonymous'} â€¢ ${new Date(thread.createdAt).toLocaleString()}</div>
      </div>

      <div class="text-center">
        <form action="/threads/${thread._id}/vote" method="POST"><input type="hidden" name="type" value="up"><button><i data-feather="arrow-up-circle"></i></button></form>
        <div class="font-bold">${thread.votes || 0}</div>
        <form action="/threads/${thread._id}/vote" method="POST"><input type="hidden" name="type" value="down"><button><i data-feather="arrow-down-circle"></i></button></form>
      </div>
    </div>

    <div class="mt-4 text-slate-200">${thread.content}</div>

    ${
      currentUser && (currentUser.role === 'admin' || currentUser.role === 'moderator' || (thread.author && thread.author._id && thread.author._id.toString() === currentUser._id.toString()))
        ? `<form action="/threads/${thread._id}/delete" method="POST" class="mt-4"><button onclick="return confirm('Delete?')" class="px-3 py-1 bg-danger rounded">Delete Thread</button></form>`
        : ''
    }
  </div>

  <div class="card p-6 rounded">
    <h3 class="font-semibold mb-4">Comments</h3>

    ${
      currentUser
        ? `<form action="/comments/${thread._id}" method="POST" class="mb-4">
            <textarea name="content" required class="w-full p-3 bg-transparent border rounded" placeholder="Write a comment..."></textarea>
            <div class="mt-2"><button class="px-3 py-2 bg-accent-2 rounded">Post Comment</button></div>
          </form>`
        : `<p class="muted">Please <a href="/login" class="text-accent-2">login</a> to comment.</p>`
    }

    ${
      (comments && comments.length > 0)
        ? `<ul class="space-y-4">
            ${comments.map(c => `
              <li id="comment-${c._id}" class="border p-4 rounded">
                <div class="flex justify-between">
                  <div>
                    <div class="font-semibold">${c.author?.username || 'Anonymous'}</div>
                    <div class="muted text-xs">${new Date(c.createdAt).toLocaleString()}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <form action="/comments/vote/${c._id}" method="POST"><input type="hidden" name="type" value="up"><button><i data-feather="arrow-up"></i></button></form>
                    <span class="font-bold">${c.votes || 0}</span>
                    <form action="/comments/vote/${c._id}" method="POST"><input type="hidden" name="type" value="down"><button><i data-feather="arrow-down"></i></button></form>
                    ${
                      currentUser && (currentUser.role === 'admin' || currentUser.role === 'moderator' || (c.author && c.author._id && c.author._id.toString() === currentUser._id.toString()))
                        ? `<form action="/comments/delete/${c._id}" method="POST"><button class="ml-2 text-red-400"><i data-feather="trash-2"></i></button></form>`
                        : ''
                    }
                  </div>
                </div>

                <p class="mt-3">${c.content}</p>

                ${
                  (repliesMap && repliesMap[c._id] && repliesMap[c._id].length > 0)
                    ? `<div class="mt-3 pl-4 border-l space-y-3">
                        ${repliesMap[c._id].map(r => `
                          <div class="bg-[#081426] p-3 rounded">
                            <div class="flex justify-between">
                              <div>
                                <div class="font-semibold">${r.author?.username || 'Anonymous'}</div>
                                <div class="muted text-xs">${new Date(r.createdAt).toLocaleString()}</div>
                              </div>
                              <div class="font-bold">${r.votes || 0}</div>
                            </div>
                            <p class="mt-2 text-sm">${r.content}</p>
                          </div>
                        `).join('')}
                      </div>`
                    : ''
                }

                ${
                  currentUser
                    ? `<form action="/comments/reply/${c._id}" method="POST" class="mt-3"><textarea name="content" rows="2" class="w-full p-2 bg-transparent border rounded" placeholder="Reply..."></textarea><div class="mt-2"><button class="px-3 py-1 bg-accent-1 rounded">Reply</button></div></form>`
                    : ''
                }

              </li>
            `).join('')}
          </ul>`
        : `<p class="muted">No comments yet. Be the first to comment!</p>`
    }

  </div>

</div>
` }) %>
